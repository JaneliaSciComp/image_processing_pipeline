{% extends "branding.html" %}
{% block content %}
  {% if submissionStatus is defined and submissionStatus is not none %}
    {% if submissionStatus == "success" %}
      <div class="alert success">
        <span class="closebtn">&times;</span> 
        <strong>Job submission successful!</strong>
      </div>
    {% else %}
      <div class="alert">
        <span class="closebtn">&times;</span> 
        <strong>Submission failed with error:</strong> {{ submissionStatus }}.
      </div>
    {% endif %}
  {% endif %}

  <!--
      Rows to configure a new job
  -->
  {% if currentTemplate is defined and currentTemplate is not none %}
    <div class="row lightsheet-row">
      <h4 id ="job-heading">Configure Job for {{ currentTemplate }}</h4>
    </div>
  {% else %}
    <div class="row lightsheet-row">
      <h4 id ="job-heading">Configure Job</h4>
    </div>
  {% endif %}

  <!-- Row with elements to configure -->
  <div class="row">
    {% if config.templates is defined and config.templates is not none %}
    <div class="col-lg-4 col-md-4 col-sm-4">
      <div class="form-group form-inline">
        <label class="lightsheet-label-configure">Template: </label>
        <select class="form-control template-dropdown" id="template-selector">
        {% if currentTemplate is defined %}
          {% for tObj in config.templates %}
            {% if currentTemplate == tObj.name %}
              <option value="{{ tObj.name }}" selected>{{ tObj.name }}</option>
            {% else %}
              <option value="{{ tObj.name }}" >{{ tObj.name }}</option>
            {% endif %}
          {% endfor %}
        {% else %}
          {% for tObj in config.templates %}
            <option value="{{ tObj.name }}" >{{ tObj.name }}</option>
          {% endfor %}
        {% endif %}
        </select>
      </div>
      <!-- Name field -->
      <div class="form-group form-inline">
        <label class="lightsheet-label-configure">Name: </label>
        <input type="text" class="form-control lightsheet-input" name="job-name" id="jobId" value="Job_{{ version }}_{{ date_now | safe | strftime_short }}_{{ machine_name }}">
      </div>
    </div>
    {% endif %}
    <div class="col-lg-8 col-md-8 col-sm-8">
      <!-- Select existing job -->
      <select class="form-control select-job" id="existing-job-selector" onchange="location = this.options[this.selectedIndex].value;">
        <option value="{{ url_for('index') }}" selected>---Select Previous Run---</option>
          {% if parentJobInfo is not none %}
            {% for currentJobInfo in parentJobInfo %}
              <option value={{ url_for('index', lightsheetDB_id=currentJobInfo._id) }} {{ currentJobInfo.selected }}>
                {% if 'creationDate' in currentJobInfo and 'selectedStepNames' in currentJobInfo%}
                  {{ currentJobInfo.jobName + " " + currentJobInfo.creationDate | strftime + " " + "(" + currentJobInfo.selectedStepNames | safe + ")"}}
                {% else %}
                  job {{ loop.index }}
                {% endif %}
              </option>
            {% endfor %}
          {% endif %}
      </select>
    </div>
  </div>

  <!--
    Accordeon control which contains the steps
  -->
  <form action="" method="post">
    <!-- button to submit the forms -->
    <input type="submit" name="postJob" class="btn btn-info submit-button" value="Submit Job" disabled onclick="dataIo.customSubmit()" />
    <div class="row lightsheet-row">
      <div id="steps">
        {% if config['steps'] is not none %}
          {% for step in config['steps'] %}
            {% if pipelineSteps is defined and pipelineSteps[step.name] is defined and pipelineSteps[step.name] is not none %}
              {% set pipelineStep = pipelineSteps[step.name] %}
              {% include "stepLoadJob.html" ignore missing with context %}
            {% else %}
              {% include "stepDefault.html" ignore missing with context %}
            {% endif %}
          {% endfor %}
        {% endif %}
      </div>
    </div>
    <input type="submit" name="postJob" class="btn btn-info submit-button" value="Submit Job" disabled onclick="dataIo.customSubmit()" />
  </form>

  <!--
      Rows to select an existing job
  -->
  <div class="row lightsheet-row" style="margin-top: 2em;">
    <h4>Previous Jobs</h4>
  </div>
  <div class="row lightsheet-row">
    <table class="table table-striped table-hover" id='job-table' />
  </div>

  <script src="{{ url_for('static', filename='js/table.js')}}"></script>
  <script src="{{ url_for('static', filename='js/submit.js') }}"></script>

  <!-- template variables to be processed in JavaScript -->
  <script>
     /*
     * Custom behavior for the lightsheet landing page
     */
     {%  if jobsJson %}
        var table_data = {{ jobsJson|safe }};
     {% else %}
        var table_data = null;
     {% endif %}

     {% if value_dependency is defined %}
        var value_dependencies = {{ value_dependency|safe }};
     {% else %}
        var value_dependencies = null;
     {% endif %}

     {% if dimension_dependency is defined %}
        var dimension_dependencies = {{ dimension_dependency|safe }};
     {% else %}
        var dimension_dependencies = null;
     {% endif %}

     {% if currentTemplate is defined %}
        // var currentTemplate = String("{{ currentTemplate|safe }}").replace(/ /g, "%20");
        var currentTemplate = String("{{ currentTemplate|safe }}");

        dataIo.currentUrl = "{{ url_for('template', template_name='placeholder') }}";
        dataIo.currentUrl = dataIo.currentUrl.replace('placeholder', currentTemplate);
     {% else %}
        var dataIo.currentTemplate = null;
        var dataIo.currentUrl = null;
     {% endif %}
  </script>

  <script src="{{ url_for('static', filename='js/landing.js') }}"></script>
  <script src="{{ url_for('static', filename='js/dependency.js') }}"></script>

  <!-- script to set default job name -->
  <script>
    $(document).ready(
      function () {
        // Show jobdata if job is selected
        var myJobIndex = null;
        {% if lightsheetDB_id is defined and jobIndex is not none %}
          myJobIndex = "{{ lightsheetDB_id|safe }}";
        {% endif %}
        if (myJobIndex && myJobIndex !== "None") {
          lightsheet.stepsExistingJob();
          var name = $('#existing-job-selector').find(":selected").text();
          $('#job-heading').text('Configure ' + name);
        }

        $('body').on('change', "select[id^='select_']", function(event){
          var inputField = this.id.replace("select_","");
          var tmp = this.parentElement.getElementsByClassName('dropdown-menu')[0];
          var selectedItems = $(tmp).find("a[aria-selected=true]");
          var nrItems = selectedItems ? selectedItems.length : 0;
          if (dimension_dependencies){
            for (var d = 0; d < dimension_dependencies.length; d++){
              var tmp = dimension_dependencies[d];
              if (tmp.input == inputField) {
                var stepPanel = $('#' + tmp.step + '-card');
                var outputObj = stepPanel.find('#' + tmp.step + "-" +tmp.output);
                var inputFields = outputObj.find(".lightsheet-nested-input");
                for (var k = 0; k < inputFields.length; k++) {
                  if (k < nrItems) {
                    $(inputFields[k]).prop('disabled', false);
                  }
                  else {
                    $(inputFields[k]).prop('disabled', true);
                  }
                }
              }
            }
          }
        });

        $('body').on('change', "input[id^='emptycheckbox_']", function(event){
          var inputField = this.id.replace("emptycheckbox_","");
          if (dimension_dependencies){
            for (var d = 0; d < dimension_dependencies.length; d++){
              var dep = dimension_dependencies[d];
              var fullFieldName = dep.step + "-" + dep.input;
              if (fullFieldName == inputField) {
                var stepPanel = $('#' + dep.step + '-card');
                var outputObj = stepPanel.find('#' + dep.step + "-" +dep.output);
                var inputFields = $(outputObj).find("input");
                if (this.checked) { // disable fields
                  inputFields.each(function(){
                    this.disabled = true;
                  })
                }
                else { // enable fields
                  inputFields.each(function(){
                    this.disabled = false;
                  })
                }
              }
            }
          }
        });

        $('#template-selector').on('change', function(event){
          var template_id = $(this).find(":selected").val();
          window.location = window.origin + '/template/' + template_id;
        });

        $('.info-icon').on('click', function(event){
          var elem = $(this.parentElement.parentElement.getElementsByClassName('parameter-hint')[0]);
          if ( elem.css("display") == "none" ) {
              elem.css("display","block");
          }
          else {
              elem.css("display","none");
          }
        });

        $.fn.dataTable.ext.errMode = 'throw';
      }
    )
  </script>
    <script>
  $(document).ready(function(){
    $(':input[type=text]').each(function(){ //Text fields can have dependencies specified in their defaults, where {dependencyID} denotes replacing the bracketed string with the value of the dependencyID text box
        let currentValue = $(this).val();
        let currentID = "#"+$(this).attr("id"); //need this b/c of https://dzone.com/articles/in-place-construction-for-stdany-stdvariant-and-st
        var dependenciesFound = currentValue.match(/{([^}]+)}/g);
        if(dependenciesFound != null){
          for (var i=0; i< dependenciesFound.length; i++){//Loop over dependencies
              let dependencyFound = dependenciesFound[i]
              var isThisALoop = dependencyFound.substr(1,dependencyFound.length-1).match(/{([^}]+)}/g); //Check if loop dependency based on whether it has {{var}}, after parsing above, will be missing a closing bracket
              if (isThisALoop != null){dependencyFound = isThisALoop[0];}
              let currentDependency="#"+dependencyFound.substr(1,dependencyFound.length-2);
              if($(currentDependency).prop('type')=="hidden"){
                temp="select_"+dependencyFound.substr(1,dependencyFound.length-2);
                currentDependency='[data-id="'+temp+'"]'; //multiselect checkbox still acts weird... cant get it to react when clicked or anything
              }
              $(currentDependency).bind("focus click keyup change checked",function(){
                let updatedValue = currentValue;
                for (var j=0; j< dependenciesFound.length; j++){//Need to loop through dependencies to ensure that all values are updated, not just the one that was just changed
                  loopedDependencyFound = dependenciesFound[j];
                  var isThisALoop = loopedDependencyFound.substr(1,loopedDependencyFound.length-1).match(/{([^}]+)}/g); //Check if loop dependency based on whether it has {{var}}, after parsing above, will be missing a closing bracket
                  if (isThisALoop != null){loopedDependencyFound = isThisALoop[0];}
                  let standardID=loopedDependencyFound.substr(1,loopedDependencyFound.length-2);
                  let dependencyToUpdate="#"+standardID; //Current one we are updating
                  let type = $(dependencyToUpdate).prop('type');
                  dependencyToUpdateValue = null; //Initialize dependencyToUpdateValue to null
                  if(type=="checkbox"){//If check box is checked, then dependencyToUpdateValue equals empty string
                    if ($(dependencyToUpdate).prop('checked')){dependencyToUpdateValue = "";}
                  }
                  else if(type == "hidden"){//Multiselect checkbox
                    dependencyToUpdate = "select_"+standardID;
                    dependencyToUpdateValue = $('[data-id="'+dependencyToUpdate+'"]').prop('title');
                    if (dependencyToUpdateValue == "Nothing selected" || dependencyToUpdateValue==undefined){dependencyToUpdateValue = null;}
                  }
                  else{//dependencyToUpdateValue takes on the value of the dependency
                    dependencyToUpdateValue = $(dependencyToUpdate).val();
                  }

                  if (standardID.match("^--") || standardID.match("^-")){ //If it starts or ends with a - or --
                      var lastIndex=standardID.lastIndexOf("_");
                      let flagName = standardID.substr(0,lastIndex);
                      if(dependencyToUpdateValue != null){ 
                        if (isThisALoop!=null){//Then this needs to loop
                          let splitString = dependencyToUpdateValue.split(" ");
                          dependencyToUpdateValue = "";
                          for(var k=0; k<splitString.length; k++){
                            if(splitString[k]!=""){dependencyToUpdateValue = dependencyToUpdateValue + flagName + " " + splitString[k] + " ";}
                          }
                          loopedDependencyFound = "{"+ loopedDependencyFound + "}";
                        }
                        else{
                          dependencyToUpdateValue = flagName + " " + dependencyToUpdateValue; 
                        }
                      }
                      else{dependencyToUpdateValue="";}
                  }
                  updatedValue = updatedValue.replace(loopedDependencyFound,dependencyToUpdateValue);
                };
                updatedValue = updatedValue.replace(/\s\s+/g, ' '); //remove extra spaces
                updatedValue = updatedValue.trim(); //remove leading/trailing spaces
                $(currentID).val(updatedValue);
          });
          //initialize
          $(currentDependency).trigger("focus");
          $(currentDependency).trigger("keyup");
          $(currentDependency).trigger("change");
          };
        };
    });
  });
</script>
{% endblock %}
