{% extends "branding.html" %}
{% block content %}
  {% if submissionStatus is not none %}
    {% if submissionStatus == "success" %}
      <div class="alert success">
        <span class="closebtn">&times;</span> 
        <strong>Job submission successful!</strong>
      </div>
    {% else %}
      <div class="alert">
        <span class="closebtn">&times;</span> 
        <strong>Submission failed with error:</strong> {{ submissionStatus }}.
      </div>
    {% endif %}
  {% endif %}

  <!--
      Rows to configure a new job
  -->
  <div class="row lightsheet-row">
    <h4>Configure Job</h4>
  </div>
  <div class="row">
    <div class="col-lg-3 col-md-3 col-sm-3">
      <!-- Name field -->
      <div class="form-group form-inline">
        <label class="lightsheet-label">Name: </label>
        <input type="text" class="form-control lightsheet-input" name="job-name" id="jobId">
      </div>
    </div>
    <div class="col-lg-6 col-md-6 col-sm-6">
      <!-- Select existing job -->
      <select class="form-control select-job" onchange="location = this.options[this.selectedIndex].value;">
        <option value="{{ url_for('index') }}" selected>---Select Previous Run---</option>
          {% if parentJobInfo is not none %}
            {% for currentJobInfo in parentJobInfo %}
              <option value={{ url_for('index', lightsheetDB_id=currentJobInfo._id) }} {{ currentJobInfo.selected }}>
                {% if 'creationDate' in currentJobInfo and 'selectedStepNames' in currentJobInfo%}
                  {{ currentJobInfo.creationDate | strftime + " " + "(" + currentJobInfo.selectedStepNames + ")"}}
                {% else %}
                  job {{ loop.index }}
                {% endif %}
              </option>
            {% endfor %}
          {% endif %}
      </select>
    </div>
  </div>

  <!--
    Accordeon control which contains the steps
  -->
  <form action="" method="post">
    <!-- button to submit the forms -->
    <input type="submit" name="postJob" id="submit-button" class="btn btn-info" value="Submit Job" disabled onclick="lightsheet.customSubmit()" /></p>
    <div class="row lightsheet-row">
      <div id="steps">
        {% for step in config['steps'] %}
          {% if pipelineSteps is defined and pipelineSteps[step.name] is defined and pipelineSteps[step.name] is not none %}
            {% set pipelineStep = pipelineSteps[step.name] %}
            {% include "stepLoadJob.html" ignore missing with context %}
          {% else %}
            {% include "stepDefault.html" ignore missing with context %}
          {% endif %}
        {% endfor %}
      </div>
    </div>
  </form>

  <!--
      Rows to select an existing job
  -->
  <div class="row lightsheet-row" style="margin-top: 2em;">
    <h4>Previous Jobs</h4>
  </div>
  <div class="row lightsheet-row">
    <table class="table table-striped table-hover" id='job-table' />
  </div>

  <!-- table variables -->
  <script>
     {%  if jobsJson %}
        var table_data = {{ jobsJson|safe }};
     {% else %}
        var table_data = null;
     {% endif %}
  </script>
  <script src="{{ url_for('static', filename='js/landing.js') }}"></script>
  <!-- contrib dependencies -->
  <script src="{{ url_for('static', filename='components/moment/min/moment.min.js') }}"></script>
  <!-- script to set default job name -->
  <script>
    $(document).ready(
      function () {
        var picker = new Pikaday({field: document.getElementById('datepicker')});
        var myJobIndex = null;
        {% if lightsheetDB_id is defined and jobIndex is not none %}
          myJobIndex = "{{ lightsheetDB_id|safe }}";
        {% endif %}
        if (myJobIndex !== null) {
          lightsheet.stepsExistingJob();
        }
        document.getElementById("jobId").defaultValue = "Job " + new Date().toISOString();
      })
  </script>
{% endblock %}
