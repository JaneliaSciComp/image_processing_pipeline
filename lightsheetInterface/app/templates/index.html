{% extends "branding.html" %}
{% block content %}
  {% if submissionStatus is defined and submissionStatus is not none %}
    {% if submissionStatus == "success" %}
      <div class="alert success">
        <span class="closebtn">&times;</span> 
        <strong>Job submission successful!</strong>
      </div>
    {% else %}
      <div class="alert">
        <span class="closebtn">&times;</span> 
        <strong>Submission failed with error:</strong> {{ submissionStatus }}.
      </div>
    {% endif %}
  {% endif %}

  <!--
      Rows to configure a new job
  -->
  <div class="row lightsheet-row">
    <h4 id ="job-heading">Configure Job</h4>
  </div>
  <div class="row">
    <div class="col-lg-3 col-md-3 col-sm-3">
      <!-- Name field -->
      <div class="form-group form-inline">
        <label class="lightsheet-label">Name: </label>
        <input type="text" class="form-control lightsheet-input" name="job-name" id="jobId" value="Job_{{ version }}_{{ date_now | safe | strftime_short }}_{{ machine_name }}">
      </div>
    </div>
    <div class="col-lg-6 col-md-6 col-sm-6">
      <!-- Select existing job -->
      <select class="form-control select-job" id="existing-job-selector" onchange="location = this.options[this.selectedIndex].value;">
        <option value="{{ url_for('index') }}" selected>---Select Previous Run---</option>
          {% if parentJobInfo is not none %}
            {% for currentJobInfo in parentJobInfo %}
              <option value={{ url_for('index', lightsheetDB_id=currentJobInfo._id) }} {{ currentJobInfo.selected }}>
                {% if 'creationDate' in currentJobInfo and 'selectedStepNames' in currentJobInfo%}
                  {{ currentJobInfo.jobName + " " + currentJobInfo.creationDate | strftime + " " + "(" + currentJobInfo.selectedStepNames | safe + ")"}}
                {% else %}
                  job {{ loop.index }}
                {% endif %}
              </option>
            {% endfor %}
          {% endif %}
      </select>
    </div>
  </div>

  <!--
    Accordeon control which contains the steps
  -->
  <form action="" method="post">
    <!-- button to submit the forms -->
    <input type="submit" name="postJob" class="btn btn-info submit-button" value="Submit Job" disabled onclick="lightsheet.customSubmit()" />
    <div class="row lightsheet-row">
      <div id="steps">
        {% for step in config['steps'] %}
          {% if pipelineSteps is defined and pipelineSteps[step.name] is defined and pipelineSteps[step.name] is not none %}
            {% set pipelineStep = pipelineSteps[step.name] %}
            {% include "stepLoadJob.html" ignore missing with context %}
          {% else %}
            {% include "stepDefault.html" ignore missing with context %}
          {% endif %}
        {% endfor %}
      </div>
    </div>
    <input type="submit" name="postJob" class="btn btn-info submit-button" value="Submit Job" disabled onclick="lightsheet.customSubmit()" />
  </form>

  <!--
      Rows to select an existing job
  -->
  <div class="row lightsheet-row" style="margin-top: 2em;">
    <h4>Previous Jobs</h4>
  </div>
  <div class="row lightsheet-row">
    <table class="table table-striped table-hover" id='job-table' />
  </div>

  <!-- template variables to be processed in JavaScript -->
  <script>
     /*
     * Custom behavior for the lightsheet landing page
     */
     {%  if jobsJson %}
        var table_data = {{ jobsJson|safe }};
     {% else %}
        var table_data = null;
     {% endif %}
     {% if value_dependency is defined %}
        var value_dependencies = {{ value_dependency|safe }};
     {% else %}
        var value_dependencies = null;
     {% endif %}
     {% if dimension_dependency is defined %}
        var dimension_dependencies = {{ dimension_dependency|safe }};
     {% else %}
        var dimension_dependencies = null;
     {% endif %}
  </script>
  <script src="{{ url_for('static', filename='js/landing.js') }}"></script>
  <script src="{{ url_for('static', filename='js/dependency.js') }}"></script>
  <!-- contrib dependencies -->
  <script src="{{ url_for('static', filename='components/moment/min/moment.min.js') }}"></script>
  <!-- script to set default job name -->
  <script>
    $(document).ready(
      function () {
        // Show jobdata if job is selected
        var myJobIndex = null;
        {% if lightsheetDB_id is defined and jobIndex is not none %}
          myJobIndex = "{{ lightsheetDB_id|safe }}";
        {% endif %}
        if (myJobIndex && myJobIndex !== "None") {
          lightsheet.stepsExistingJob();
          var name = $('#existing-job-selector').find(":selected").text();
          $('#job-heading').text('Configure ' + name);
        }

        $('body').on('change', "select[id^='select_']", function(event){
          var inputField = this.id.replace("select_","");
          var tmp = this.parentElement.getElementsByClassName('dropdown-menu')[0];
          var selectedItems = $(tmp).find("a[aria-selected=true]");
          var nrItems = selectedItems ? selectedItems.length : 0;
          if (dimension_dependencies){
            for (var d = 0; d < dimension_dependencies.length; d++){
              var tmp = dimension_dependencies[d];
              if (tmp.input == inputField) {
                var stepPanel = $('#' + tmp.step + '-card');
                var outputObj = stepPanel.find('#' + tmp.step + "-" +tmp.output);
                var inputFields = outputObj.find(".lightsheet-nested-input");
                for (var k = 0; k < inputFields.length; k++) {
                  if (k < nrItems) {
                    $(inputFields[k]).prop('disabled', false);
                  }
                  else {
                    $(inputFields[k]).prop('disabled', true);
                  }
                }
              }
            }
          }
        });

        $('body').on('change', "input[id^='emptycheckbox_']", function(event){
          var inputField = this.id.replace("emptycheckbox_","");
          if (dimension_dependencies){
            for (var d = 0; d < dimension_dependencies.length; d++){
              var dep = dimension_dependencies[d];
              var fullFieldName = dep.step + "-" + dep.input;
              if (fullFieldName == inputField) {
                var stepPanel = $('#' + dep.step + '-card');
                var outputObj = stepPanel.find('#' + dep.step + "-" +dep.output);
                var inputFields = $(outputObj).find("input");
                if (this.checked) { // disable fields
                  inputFields.each(function(){
                    this.disabled = true;
                  })
                }
                else { // enable fields
                  inputFields.each(function(){
                    this.disabled = false;
                  })
                }
              }
            }
          }
        });
      }
    )
  </script>
{% endblock %}
