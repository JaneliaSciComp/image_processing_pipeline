{% from "_formhelpers.html" import render_field %}
<!-- This file contains the template code for each and every pipeline step and includes a separate template to render each parameter -->
<div class="card" id="{{ step.name }}-card">
    <div class="card-header" id="headingOne">
        <h5 class="mb-0">
            {% if pipelineStep.collapseOrShow=="show" %}
                <b data-toggle="collapse" class="expand-icon" data-target="#collapse{{ step.name }}"
                   id="expandIcon-{{ step.name }}" onclick="lightsheet.expandStep(this)">&#x25BE</b>
            {% else %}
                <b data-toggle="collapse" class="expand-icon" data-target="#collapse{{ step.name }}"
                   id="expandIcon-{{ step.name }}" onclick="lightsheet.expandStep(this)">&#x25B8</b>
            {% endif %}
            <label>
                <input
                        id="check-{{ step.name }}"
                        type="checkbox"
                        class="step-name step-checkbox"
                        aria-controls="collapse{{ step.name }}"
                        value={{ step.name + "_checkbox" }}
                                onclick="lightsheet.testAllCheckboxes(this)"
                        {{ pipelineStep.checkboxState }}
                        style="cursor:default"
                        data-steptype="{{ step.steptype }}">
                {{ step.description }}
            </label>
            {% if step.steptype != "" %}
                <div style="display: inline" class="pause-check">
                    <label>
                        {% if pipelineStep.pause==1 %}
                            <input id="pausecheck-{{ step.name }}" type="checkbox" checked>
                        {% else %}
                            <input id="pausecheck-{{ step.name }}" type="checkbox">
                        {% endif %}
                        Pause</label>
                </div>
            {% endif %}
        </h5>
    </div>
    <div id="collapse{{ step.name }}" class="collapse {{ pipelineStep.collapseOrShow }}" aria-labelledby="headingOne"
         data-parent="#accordion">
        <div class="card-body">
            {% include "tabnav.html" %}
            {% set panels = ['frequent', 'sometimes', 'rare'] %}
            <!-- Tab panes -->
            <div class="tab-content">
                {% for panel in panels %}
                    {% if panel == 'frequent' %}
                        <div role="tabpanel" class="tab-pane active lightsheet-tab" id="{{ panel }}-{{ step.name }}">
                    {% else %}
                        <div role="tabpanel" class="tab-pane lightsheet-tab" id="{{ panel }}-{{ step.name }}">
                    {% endif %}
                {% for param in step.parameter %} <!-- TODO: Loop over parameters in outer loop --!>
                    {% if param.frequency == panel[0].upper() %}
                        {% set value = param %}
                        {% set meta = value %}
                        {% set keyForProvidedStep = param.name.rpartition("_")[0] %}
                        {% set defaultValueNumber1 = param.number1 %}
                        {% set defaultValueNumber2 = param.number2 %}
                        {% set defaultValueNumber3 = param.number3 %}
                        {% set defaultValueNumber4 = param.number4 %}
                        {% set defaultValueNumber5 = param.number5 %}
                        {% set defaultValueNumber6 = param.number6 %}
                        {% set defaultValueText1 = param.text1 %}
                        {% set defaultValueText2 = param.text2 %}
                        {% set defaultValueText3 = param.text3 %}
                        {% set defaultValueText4 = param.text4 %}
                        {% set defaultValueText5 = param.text5 %}
                        {% set defaultValueFloat1 = param.float1 %}
                        {% if pipelineStep is not none and keyForProvidedStep in pipelineStep['jobs'][panel] %}
                            {% set usesDefaultStepValue=False %}
                            {#Set defaults, useful for dependencies#}
                            {% set data = pipelineStep['jobs'][panel][keyForProvidedStep].data %}
                        {% else %}
                            {% set usesDefaultStepValue=True %}
                            {% if meta.formatting == 'C' and pipelineStep is none %}
                                {% set data = [param.number1] %}
                                {% elif meta.formatting == 'B' or meta.formatting == 'D' %}{#Radio Button or Dropdown Menu#}
                                {% if param.text5 %}
                                    {% set data = [param.text1, param.text2, param.text3, param.text4, param.text5] %}
                                {% elif param.text4 %}
                                    {% set data = [param.text1, param.text2, param.text3, param.text4] %}
                                {% elif param.text3 %}
                                    {% set data = [param.text1, param.text2, param.text3] %}
                                {% elif param.text2 %}
                                    {% set data = [param.text1, param.text2] %}
                                {% elif param.text1 %}
                                    {% set data = [param.text1] %}
                                {% elif param.number6 %}
                                    {% set data = [param.number1, param.number2, param.number3, param.number4, param.number5, param.number6] %}
                                {% elif param.number5 %}
                                    {% set data = [param.number1, param.number2, param.number3, param.number4, param.number5] %}
                                {% elif param.number4 %}
                                    {% set data = [param.number1, param.number2, param.number3, param.number4] %}
                                {% elif param.number3 %}
                                    {% set data = [param.number1, param.number2, param.number3] %}
                                {% elif param.number2 %}
                                    {% set data = [param.number1, param.number2] %}
                                {% elif param.number1 %}
                                    {% set data = [param.number1] %}
                                {% endif %}
                            {% elif meta.type == "Text" or meta.formatting=='A' %}
                                {% set defaultValueText1 = param.text1 %}
                                {% set data = param.text1 %}
                            {% elif meta.type =="Float" %}
                                {% set data = param.float1 %}
                            {% else %}
                                {% if meta.count == '1' %}
                                    {% set data = param.number1|int %}
                                {% elif meta.count == '2' %}
                                    {% set data = [param.number1, param.number2] %}
                                {% elif meta.formatting == 'R' %}
                                    {% set data = {'start': param.number1, 'end': param.number2, 'every': param.number3} %}
                                {% elif meta.count == '3' %}
                                    {% set data = [param.number1, param.number2, param.number3] %}
                                {% elif meta.count == '4' %}
                                    {% set data = [param.number1, param.number2, param.number3, param.number4] %}
                                {% elif meta.count == '5' %}
                                    {% set data = [param.number1, param.number2, param.number3, param.number4, param.number5] %}
                                {% elif meta.count == '6' %}
                                    {% set data = [param.number1, param.number2, param.number3, param.number4, param.number5, param.number6] %}
                                {% endif %}
                            {% endif %}
                        {% endif %}
                        {% include "parameter.html" ignore missing with context %}
                    {% endif %}
                {% endfor %}
                </div>
                {% endfor %}
                {% if 'GLOBALPARAMETERS' in step.name.upper() %}
                    <div class="col-md-12">
                        <input class="btn btn-info apply-button" type="button" value="Apply"
                               title="Apply global parameters to other steps in the pipeline"
                               onclick="dependency.applyGlobalParameter()"/>
                    </div>
                {% endif %}
                </div>
            </div>
        </div>
    </div>